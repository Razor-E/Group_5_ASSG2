---
title: "Group 5 ASSG2"
output:
  pdf_document: default
  html_document: default
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,error = FALSE, message = FALSE,
                      warning = FALSE,
                      out.height = "\\textheight",  out.widtibh = "\\textwidth")
```

```{r packages, include=FALSE}
library(pagedown) # For simulating PDFs before knitting
library(dplyr)
library(psych) # For describe() providing summary stats
library(quantmod) # For importing stock from Yahoo
library(ggplot2) # Visualizations
library(forecast) # Autoplot
library(tseries) # ADF test and more
library(FinTS) # ARCH LM test
library(rugarch) # For ARCH(p) models
library(tibble)
library(scales) # For dates
library(tsDyn) # Sign Bias Test for leverage effect
```

**Importing Ford Motor Company stock statistics**

```{r importing, echo=TRUE}
#This code does it.
getSymbols('F', src = 'yahoo', from = as.Date('2022-01-01'), to = 
             as.Date('2025-03-20'))
```
**Some Ford's stock closing prices**

```{r closing prices, echo=FALSE}
F_closing <- F$F.Close
head(F_closing)
```
\newpage

**Time series plot of Ford's Closing prices**

```{r ts conversion, echo=FALSE}
F_closing_ts <- ts(F_closing, start = c(2022,1), frequency = 240)
autoplot(F_closing_ts) + ggtitle('Ford Company Stock closing prices')
```

-Ford Company's stock prices have been going down over the course of the 4 years. A sharp drop can be seen from the start of 2022 to the middle of the same year.

-Some seasonality can be seen from the middle of 2022 to the middle of 2023.

-We need to eliminate these components, so that the resulting time series can be easier to work with. Computing the log returns has the same effect as differencing the log of the time series. It can be shown that these returns exhibit stationarity from tests seen further below.

```{r daily log returns, echo=TRUE}
#This computes the daily log returns
F_returns <- diff(log(F_closing_ts))
```

*Some daily log returns*

```{r log returns, echo=FALSE}
tail(F_returns)
```


\newpage

**PART 1: EXPLORATORY DATA ANALYSIS**

**Log-returns ts plot**

```{r returns plot, echo=FALSE}
autoplot(F_returns) + 
  ggtitle('Ford Motor Stock daily log returns')
```


**Summary statistics of the returns**

```{r summary statistics, echo=FALSE}
describe(F_returns)
```

*Ford Company's stock returns have a mean of zero and a variance of 1. This can imply stationarity since these statistics do not change over time, but further tests are needed to truly confirm this.*

-Skewness measures asymmetry. This tells us whether there are extreme values on the left or on the right.

*The negative skewness of -1 suggests the returns have a slightly longer left tail. Large losses are therefore more likely to occur.*

-Kurtosis measures the tailedness of a distribution. This shows how often extreme values occur as compared to a normal distribution (Where kurtosis = 3).

*Results show that returns have a high kurtosis (returns are leptokurtic). Losses (or gains) occur more frequently than normal. This implies higher risk involved with this stock.*

\newpage

**ADF Stationarity test**

-Null hypothesis: The Series is non-stationary

*Fail to reject if P > [level of significance]*

-Alternative hypothesis: The Series is stationary

*Reject Null in favour of the alternative if P < [level of significance]*

-The results are as shown:

```{r adf, echo=FALSE}
print(adf.test(F_returns))
```

-Assuming the default significance level of 5% (0.05), The p-value shown is less than this. We therefore reject the null hypothesis in favour of the alternative one and conclude that Ford's returns are indeed stationary.

\newpage

**Checking for ARCH effects on squared returns**

```{r ARCH effects, echo=FALSE}
ggAcf(F_returns^2) + 
  ggtitle('Autocorrelations of Ford Company squared returns')
```

-Only 7 out of 480 lags exceed the confidence interval(~1.458% of lags). At 5% significance, 24 lags (480 * 5%) or more exceeding the confidence level would be regarded as statistically significant. We can therefore safely ignore all the lags appearing above the ci as there are statistically insignificant.

-The above plot therefore shows no significant autocorrelations seen from the squared returns; and therefore no volatility clustering. This means that volatility (squared returns) is homoscedastic (not heteroscedastic)... the variance, or volatility, is therefore constant. There are therefore no ARCH effects.

-ARCH effects can further be tested in depth using the Lagrange Multiplier (LM) test. 

\newpage

**ARCH-LM test**

-Null hypothesis: No ARCH effects (homoscedasticity)

-Alternative hypothesis: There is ARCH effects (heteroscedasticity)

*Reject Null hypothesis if P < [level of significance]*

```{r ARCH-LM, echo=FALSE}
print(ArchTest(F_returns))
```
-The p-value (0.9881) is significantly more than 0.05. We therefore fail to reject the Null hypothesis and conclude that Ford Company's stock returns are homoscedastic; they exhibit no ARCH effects.

\newpage

**PART 2 ARCH**

**Estimating ARCH(p)**

```{r modelling, echo=TRUE}
# Initialize vectors to store AIC values and models
aic_values <- numeric(5)
models <- list()

# Loop over p from 1 to 5 to find best ARCH(p)
for (p in 1:5) {
  # Define ARCH(p) spec as sGARCH(p, 0) with zero-mean
  spec <- ugarchspec(
    variance.model = list(model = "sGARCH", garchOrder = c(p, 0)),
    mean.model = list(armaOrder = c(0, 0), include.mean = FALSE),  # Zero-mean model
    distribution.model = "norm"  # Normal distribution
  )
  
  # Fit the model to returns
  fit <- ugarchfit(spec = spec, data = F_returns)
  
  # Save AIC value
  aic_values[p] <- infocriteria(fit)[1]
  
  # Save model object
  models[[p]] <- fit
  
  # Print AIC for each p
  cat("ARCH(", p, ") AIC:", aic_values[p], "\n")
}
```

-The best model has the lowest AIC which is an ARCH(5) model as shown:

```{r lowest AIC, echo=FALSE}
# Find best p based on minimum AIC
best_p <- which.min(aic_values)
cat("\nBest ARCH(p): p =", best_p, "with AIC =", aic_values[best_p], "\n")
```
-The AIC indicates that 5 lags were optimal, suggesting that the conditional variance is influenced by the past five squared errors. A lower AIC value suggests a better model. 

-When the value of P was 5, the AIC had the lowest value.

\newpage

**Extract and plot the conditional volatility** 

```{r visualization}
best_model <- models[[best_p]]
conditional_volatility <- sigma(best_model)

num_obs <- length(conditional_volatility)

date_seq <- seq.Date(from = as.Date('2022-01-01'), 
                     to = as.Date('2025-03-20'), 
                     length.out = num_obs)

vol_data <- tibble(Time = date_seq, 
                   Volatility = conditional_volatility)

ggplot(vol_data, aes(x = Time, y = Volatility)) +
  geom_line() +
  labs(title = "Conditional Volatility Over Time",x = "Time",
       y = "Estimated Volatility") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

*The extreme spikes around August 2024, November 2023,and around October show sudden market shocks or major financial events.* 

-This means that there is higher risk involved for investors at this time. Traders of Ford's stock should have expected either a huge loss or a huge gain at this point in time.

-Higher volatility is disadvantageous to investors due to a high uncertainty involved in this stock. However, this could be great for traders who profit from volatility such as option traders.

-Some seasonality can be seen here. This proves that there is conditional heteroscedasticity or volatility clustering; Periods of low volatility following periods of high volatility.

\newpage

**Checking standardized residuals for autocorrelation**

```{r standardized}
# Extract standardized residuals
std_residuals <- residuals(best_model, standardize = TRUE)
```

-The Ljung Box test is used to check for this.

-Null hypothesis: No correlations are present in the data

*Fail to reject the Null hypothesis if P>[level of significance]*

-Results at alpha=0.05 are shown below

**Are there correlations in the residuals?**

```{r Ljung}
# Ljung-Box test for autocorrelation in standardized residuals
Box.test(std_residuals, lag = 10, type = "Ljung-Box")
```
-The p-value shown is significantly higher than 0.05. We therefore fail to reject the null hypothesis and conclude that the standardized residuals are purely white noise.

**Are there ARCH effects in the residuals?**

-Squaring the standard deviation of residuals gives us its variance which is similar to volatility.

-Testing whether the volatility of the residuals have any correlation also gives us the same result as shown below.

```{r Ljung arch}
# Ljung-Box test for squared standardized residuals (tests for remaining ARCH effects)
Box.test(std_residuals^2, lag = 10, type = "Ljung-Box")
```
-The p-value is higher than our 5% significance level and therefore, we fail to reject the null hypothesis. There is enough evidence to conclude that volatility of residuals have no correlations. There is therefore no remaining ARCH effects.

\newpage

```{r Ljung plots}
# ACF plots
par(mfrow = c(1, 2))
ggAcf(std_residuals) + ggtitle("Std Residuals")
ggAcf(std_residuals^2) + ggtitle("Volatility of Residuals")
```

-In both these plots, there is no significant spikes above the confidence intervals indicating no potential autocorrelation.

-The model is therefore well specified and there is no linear dependence in the residuals.

\newpage

**Discussion: Why ARCH(p) May Be Insufficient for Financial Volatility**

#Captures short-term volatility clustering poorly.

ARCH models require high orders (large p) to capture persistent volatility, which can lead to overfitting and inefficient estimation.

#Volatility persistence is not well-modeled.

Financial returns show long memory in volatility. ARCH models do not allow for volatility to decay slowly over time like GARCH models do.

#Cannot model asymmetry (leverage effect).

Financial markets often exhibit asymmetric volatility (negative shocks increase volatility more than positive shocks). ARCH ignores this.

#Residual diagnostics may show remaining ARCH effects.

Even after fitting ARCH, squared standardized residuals may still show autocorrelation, indicating that the model hasn't captured all dynamics.

\newpage

**PART 3: GARCH**

**Selecting the best GARCH(1,1) model with AR(1)**

```{r defining models}
garch_specs <- list(
  normal = ugarchspec(variance.model = list(model = "sGARCH",
                                            garchOrder = c(1,1)),
                      mean.model = list(armaOrder = c(1,0)), #AR(1)
                      distribution.model = "norm"), #Normal

  student_t = ugarchspec(variance.model = list(model = "sGARCH",
                                               garchOrder = c(1,1)),
                         mean.model = list(armaOrder = c(1,0)),
                         distribution.model = "std"),  # Student-t

  skewed_student_t = ugarchspec(variance.model = list(model="sGARCH",
                                                      garchOrder =
                                                        c(1,1)),
                                mean.model = list(armaOrder =c(1,0)),
                                distribution.model = "sstd")  # Skewed Student-t
)
```

```{r fitting}
garch_fits <- lapply(garch_specs, 
                     function(spec) ugarchfit(spec, data =F_returns))
```

```{r comparing}
bic_values <- sapply(garch_fits,
                     function(model)infocriteria(model)[2])
best_model_name <- names(which.min(bic_values))
best_GARCH <- garch_fits[[best_model_name]]
bic_values
cat("Best Model Based on BIC:", best_model_name, "\n")
```
-The best GARCH(1,1) model features the Student-t as a distribution to use for the conditional density as it has the lowest BIC values.

**Interpreting Parameters**

```{r parameters}
best_GARCH
```

**mu**-:Expected returns of the time series. The mean returns

**ar1**-:This is the Autoregressive term in the G**AR**CH model. It measures how much past returns influence current returns.

**Omega**-:The constant in the variance equation; a higher value suggests persistent volatility.

**Alpha1**-:This is the ARCH effect. It represents how much past shocks impact the current volatility.

**Beta1**-:Measures how much past volatility affects current volatility. This is the GARCH effect

**Shape** adjusts how much the Student-t distribution captures asymmetry.

\newpage

**Distributions and their effect on parameter estimates**

**Normal Distribution**

-It assumes that data follows a bell shape with no fat tail. This means it assumes data has constant skewness and kurtosis.

-It therefore captures extreme returns poorly

-Tends to overestimate beta1 (GARCH persistence) because it tries to explain extreme movements through long memory rather than fat tails.

-Alpha1 may be artificially high to compensate for underestimated tail risk.

**Student-t Distribution**

-Captures fat tails and is therefore better suited for financial returns than the normal distribution. This results in a more accurate volatility clustering.

-Alpha1 (ARCH) tends to be lower because large shocks are now better explained by the distribution.

-Beta1 (GARCH) is lower than in the normal case, meaning volatility decays faster and isn’t overestimated.

**Skewed Student-t Distribution**

-Captures both fat tails and skewness.

-Estimates an extra skewness parameter, which adjusts for whether large losses/gains are more frequent.

-Beta1 (GARCH) is usually lower, meaning shocks decay more realistically.

-It is a better fit for financial data where negative shocks are larger than positive ones such as in stock markets.

\newpage

**Plot of Conditional Volatilities**

```{r conditional garch}
garch_conditional_volatility <- sigma(best_GARCH)

garchvolatility_num_obs <- length(garch_conditional_volatility)

date_seq3 <- seq.Date(from = as.Date('2022-01-01'), 
                     to = as.Date('2025-03-20'), 
                     length.out = garchvolatility_num_obs)

garch_data <- tibble(Time3 = date_seq3, 
                   Volatility3 = garch_conditional_volatility)

ggplot(garch_data, aes(x = Time3, y = Volatility3)) +
  geom_line() +
  labs(title = "Conditional Volatility",x = "Time",
       y = "Estimated Volatility") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

-The estimated volatility appears to be decreasing from early 2022 to mid-2023. This might indicate reduced uncertainty and better market stabilization for the stock.

-There are fluctuations, with volatility peaking around mid-2022 and experiencing a sharp decline afterward.

-There is a noticeable increase in volatility in November 2023 and August 2024. This could indicate strong economic news or financial events.

\newpage

**Residual diagnostics**

```{r resi}
garch_residuals <- residuals(best_GARCH)
ggAcf(garch_residuals)
```

-Correlations above the ci are fewer than 5% of the total lags and are therefore insignificant. All others are below the ci and therefor show no correlation with previous lags. The residuals are therefore uncorrelated.

```{r}
qqnorm(garch_residuals, main = 'Q-Q plot of residuals')
qqline(garch_residuals, col='red')
```

-Most points align closely with the red reference line in the central portion suggesting that the bulk of the residuals follow a normal distribution.

-The points deviate slightly from the reference line at both the lower and upper extremes suggesting the presence of heavy tails (fat tails) or slight skewness, which means the residuals may not be perfectly normal.

\newpage

**Assessing volatility clustering**

```{r assess}
std_res_garch <- residuals(best_GARCH, standardize=TRUE)
ggAcf(std_res_garch^2)
```

-The autocorrelation of squared standardized residuals is insignificant. Volatility clustering is therefore properly captured by the GARCH(1,1) model.


```{r box}
Box.test(std_res_garch^2, type = "Ljung-Box")
```

The p-value 0.7271 is greater than 0.05 thus we fail to reject the null hypothesis and conclude that there is no remaining volatility clustering meaning that GARCH(1,1) successfully modeled the volatility dynamics.

\newpage
**Assessing Leverage Effects**

```{r}
ggAcf(std_res_garch^2)
```

-Negative shocks have stronger autocorrelations than positive ones, leverage effects may exist.

```{r sign bias}
res_neg <- ifelse(std_res_garch < 0, std_res_garch, 0)
sign_bias_test <- lm(std_res_garch^2 ~ res_neg)
summary(sign_bias_test)
```

-The coefficient for res_neg is -4.6328 and is highly significant (p-value < 2.2e-16), suggesting that negative shocks significantly impact volatility, which is characteristic of leverage effects.

-Leverage effects are present: This means that negative shocks increase volatility more than positive shocks of the same magnitude.

\newpage
**Forcasting volatility for each model**

```{r forecast}
# Forecast 10 periods ahead for all models
garch_forecasts <- lapply(garch_fits, function(fit) ugarchforecast(fit, n.ahead = 10))

vol_forecasts <- lapply(garch_forecasts, function(f) sigma(f))


vol_df <- data.frame(
  Period = 1:10,
  Normal = as.vector(vol_forecasts[[1]]),
  Student_t = as.vector(vol_forecasts[[2]]),
  Skewed_Student_t = as.vector(vol_forecasts[[3]])
)

# Plot
ggplot(vol_df, aes(x = Period)) +
  geom_line(aes(y = Normal, color = "Normal")) +
  geom_line(aes(y = Student_t, color = "Student-t")) +
  geom_line(aes(y = Skewed_Student_t, color = "Skewed Student-t")) +
  labs(title = "GARCH Forecasted Volatility",
       y = "Forecasted Volatility",
       x = "Periods Ahead") +
  theme_minimal()

```

-The Normal GARCH model indicates a high degree of volatility persistence, meaning past shocks have a long-lasting impact.

-The t-distribution-based models predict that volatility will slowly decrease, indicating a less persistent shock effect.

-The Student-t and Skewed Student-t models assume that financial returns exhibit fat tails; they capture some market risk more effectively.

-The Normal model seems to overestimate long-term volatility, which could lead to overly cautious risk assessments.

-The Skewed Student-t (green) and Student-t (blue) models both show a gradual decline in volatility, suggesting that these models expect market uncertainty to reduce over time.

\newpage

**Comparing ARCH(5) and GARCH(1,1) using likelihood ratio test**

```{r likelihood}
logL_arch <- likelihood(best_model)
logL_garch <- likelihood(best_GARCH)

# Compute Likelihood Ratio (LR) test statistic
LR_stat <- 2 * (logL_garch - logL_arch)

# p-value from Chi-square distribution with 1 df (one additional parameter in GARCH)
p_value <- 1 - pchisq(LR_stat, df = 1)

# Display results
cat("Likelihood Ratio Test:\n")
cat("Log-Likelihood (ARCH):", logL_arch, "\n")
cat("Log-Likelihood (GARCH):", logL_garch, "\n")
cat("LR Statistic:", LR_stat, "\n")
cat("p-value:", p_value, "\n")

# Decision
if (p_value < 0.05) {
  cat("GARCH(1,1) significantly improves model fit (Reject ARCH-only model)\n")
} else {
  cat("No significant improvement; ARCH(p) may be sufficient\n")
}
```

\newpage
**Asymmetric GJR-GARCH and News Impact Curve**

**Fitting a GJR-GARCH(1,1) model**

```{r gjr}
sample_returns <- tail(F_returns, 250)

gjr_spec <- ugarchspec(
  variance.model = list(model = "gjrGARCH", garchOrder = c(1, 1)),
  mean.model = list(armaOrder = c(1, 0), include.mean = TRUE),
  distribution.model = "std"
)

gjr_fit <- ugarchfit(spec = gjr_spec, data = sample_returns)

show(gjr_fit)
```

#High p-values (greater than 0.05) mean no significant bias
#p-value is 0.7511 → You fail to reject the null hypothesis of no remaining asymmetry.

**Estimate the leverage parameter and test its significance**

```{r leverage parameter}
# View model results
show(gjr_fit)

# Extract coefficients table
coef_table <- gjr_fit@fit$matcoef
print(coef_table)
```

#Sign Bias test (p = 0.32): Not significant. No evidence that positive or negative shocks lead to different volatility responses.

#Negative Sign Bias test (p = 0.69): Not significant. Negative shocks don't disproportionately affect volatility.

#Positive Sign Bias test (p = 0.84): Not significant. Positive shocks don't disproportionately affect volatility.

#Joint Effect test (p = 0.75): Not significant. There's no joint evidence of asymmetry or leverage effects.

\newpage

**Plotting the NIC for both GARCH(1,1) and GJR-GARCH(1,1) models**

```{r fitting GJR-GARCH(1,1)}
gjr_spec <- ugarchspec(
  variance.model = list(model = "gjrGARCH", garchOrder = c(1, 1)),
  mean.model = list(armaOrder = c(1, 0), include.mean = TRUE),
  distribution.model = "std"
)

gjr_fit <- ugarchfit(spec = gjr_spec, data = F_returns)
```

```{r extracting GARCH(1,1) coefficients}
garch_coef <- coef(best_GARCH)
omega_g <- garch_coef["omega"]
alpha_g <- garch_coef["alpha1"]
beta_g  <- garch_coef["beta1"]
```

```{r extracting GJR-GARCH(1,1) coefficients}
gjr_coef <- coef(gjr_fit)
omega_j <- gjr_coef["omega"]
alpha_j <- gjr_coef["alpha1"]
gamma_j <- gjr_coef["gamma1"]
beta_j  <- gjr_coef["beta1"]
```

```{r constructing NICs}
# Shock values from -10% to +10%
shocks <- seq(-0.10, 0.10, by = 0.001)

# Unconditional variances
unc_var_garch <- omega_g / (1 - alpha_g - beta_g)
unc_var_gjr <- omega_j / (1 - alpha_j - 0.5 * gamma_j - beta_j)

# NIC for GARCH(1,1)
nic_garch <- omega_g + alpha_g * shocks^2 + beta_g * unc_var_garch

# NIC for GJR-GARCH(1,1)
I_neg <- ifelse(shocks < 0, 1, 0)
nic_gjr <- omega_j + (alpha_j + gamma_j * I_neg) * shocks^2 + beta_j * unc_var_gjr
```

```{r plotting NICs}
nic_data <- data.frame(
  shocks = rep(shocks, 2),
  NIC = c(nic_garch, nic_gjr),
  Model = rep(c("GARCH(1,1)", "GJR-GARCH(1,1)"), each = length(shocks))
)

# Plot NIC
ggplot(nic_data, aes(x = shocks, y = NIC, color = Model)) +
  geom_line(size = 1) +
  labs(title = "News Impact Curve (NIC)",
       x = "Shocks",
       y = "Conditional Variance") +
  theme_minimal() +
  scale_color_manual(values = c("blue", "red"))
```

**GARCH(1,1) (Blue Curve)**

-The curve is symmetric around zero.Both positive and negative shocks have the same impact on volatility.This suggests that the GARCH model does not capture asymmetric effects.

**GJR-GARCH(1,1) (Red Curve)**

-The curve is higher than the GARCH(1,1) curve, indicating that this model generally assumes a higher level of conditional variance.

-The curve is asymmetric:

-For negative shocks (left side), volatility is higher compared to positive shocks of the same magnitude.

-This confirms the leverage effect: bad news (negative returns) increases volatility more than good news (positive returns).

\newpage

**Using the fitted GJR-GARCH(1,1) model to forecast volatility**

```{r fv}
gjr_forecast <- ugarchforecast(gjr_fit, n.ahead = 10)

# Extract sigma (volatility forecasts)
gjr_volatility <- as.numeric(sigma(gjr_forecast))

# Extracting standard deviation of conditional variance forecasts
gjr_variance <- as.numeric(fitted(gjr_forecast)^2)

gjr_upper <- gjr_volatility + 1.96 * sqrt(gjr_variance)  # Upper bound (95% CI)
gjr_lower <- gjr_volatility - 1.96 * sqrt(gjr_variance)  # Lower bound (95% CI)
```

```{r plot fvnic}
forecast_data <- data.frame(
  Days = 1:10,
  Volatility = gjr_volatility,
  Upper_CI = gjr_upper,
  Lower_CI = gjr_lower
)

# Plot
ggplot(forecast_data, aes(x = Days, y = Volatility)) +
  geom_line(color = "blue", size = 1) +
  geom_ribbon(aes(ymin = Lower_CI, ymax = Upper_CI), fill = "blue", alpha = 0.2) +
  ggtitle("GJR-GARCH(1,1) Forecasted Volatility with 95% CI") +
  xlab("Trading Days Ahead") +
  ylab("Forecasted Volatility") +
  theme_minimal()
```

-The forecasted volatility remains almost constant over time, suggesting a mean-reverting behavior in volatility.

-The confidence intervals expand initially but stabilize over time.This suggests that uncertainty in forecasting is higher in the short term but stabilizes as the model converges.

-The GJR model accounts for leverage effects, meaning negative shocks (bad news) impact volatility more than positive shocks.